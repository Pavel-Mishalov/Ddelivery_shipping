jQuery(function(a){
  if("undefined"==typeof wc_checkout_params)
    return!1;
  a.blockUI.defaults.overlayCSS.cursor="default";
  var b={updateTimer:!1,dirtyInput:!1,xhr:!1,$order_review:a("#order_review"),$checkout_form:a("form.checkout"),
  init:function(){
    a(document.body).bind("update_checkout",this.update_checkout),
    a(document.body).bind("init_checkout",this.init_checkout),
    this.$checkout_form.on("click",'input[name="payment_method"]',this.payment_method_selected),
    a(document.body).hasClass("woocommerce-order-pay")&&this.$order_review.on("click",'input[name="payment_method"]',this.payment_method_selected),
    this.$checkout_form.on("submit",this.submit),
    this.$checkout_form.on("blur change",".input-text, select, input:checkbox",this.validate_field),
    this.$checkout_form.on("update",this.trigger_update_checkout),
    this.$checkout_form.on("change",'select.shipping_method, input[name^="shipping_method"], #ship-to-different-address input, .update_totals_on_change select, .update_totals_on_change input[type="radio"]',this.trigger_update_checkout),
    this.$checkout_form.on("change",".address-field select",this.input_changed),
    this.$checkout_form.on("change",".address-field input.input-text, .update_totals_on_change input.input-text",this.maybe_input_changed),
    this.$checkout_form.on("change keydown",".address-field input.input-text, .update_totals_on_change input.input-text",this.queue_update_checkout),
    this.$checkout_form.on("change","#ship-to-different-address input",this.ship_to_different_address),
    this.$checkout_form.find("#ship-to-different-address input").change(),
    this.init_payment_methods(),
    "1"===wc_checkout_params.is_checkout&&a(document.body).trigger("init_checkout"),
    "yes"===wc_checkout_params.option_guest_checkout&&a("input#createaccount").change(this.toggle_create_account).change()
  },
  init_payment_methods:function(b){var c=a(".woocommerce-checkout").find('input[name="payment_method"]');1===c.length&&c.eq(0).hide(),b&&a("#"+b).prop("checked",!0),0===c.filter(":checked").length&&c.eq(0).prop("checked",!0),c.filter(":checked").eq(0).trigger("click")},get_payment_method:function(){return b.$order_review.find('input[name="payment_method"]:checked').val()},payment_method_selected:function(){if(a(".payment_methods input.input-radio").length>1){var b=a("div.payment_box."+a(this).attr("ID"));a(this).is(":checked")&&!b.is(":visible")&&(a("div.payment_box").filter(":visible").slideUp(250),a(this).is(":checked")&&a("div.payment_box."+a(this).attr("ID")).slideDown(250))}else a("div.payment_box").show();a(this).data("order_button_text")?a("#place_order").val(a(this).data("order_button_text")):a("#place_order").val(a("#place_order").data("value"))},toggle_create_account:function(){a("div.create-account").hide(),a(this).is(":checked")&&a("div.create-account").slideDown()},init_checkout:function(){a("#billing_country, #shipping_country, .country_to_state").change(),a(document.body).trigger("update_checkout")},maybe_input_changed:function(a){b.dirtyInput&&b.input_changed(a)},input_changed:function(a){b.dirtyInput=a.target,b.maybe_update_checkout()},queue_update_checkout:function(a){var c=a.keyCode||a.which||0;return 9===c||(b.dirtyInput=this,b.reset_update_checkout_timer(),void(b.updateTimer=setTimeout(b.maybe_update_checkout,"1000")))},trigger_update_checkout:function(){b.reset_update_checkout_timer(),b.dirtyInput=!1,a(document.body).trigger("update_checkout")},maybe_update_checkout:function(){var c=!0;if(a(b.dirtyInput).length){var d=a(b.dirtyInput).closest("div").find(".address-field.validate-required");d.length&&d.each(function(){""===a(this).find("input.input-text").val()&&(c=!1)})}c&&b.trigger_update_checkout()},ship_to_different_address:function(){a("div.shipping_address").hide(),a(this).is(":checked")&&a("div.shipping_address").slideDown()},reset_update_checkout_timer:function(){clearTimeout(b.updateTimer)},validate_field:function(){var b=a(this),c=b.closest(".form-row"),d=!0;if(c.is(".validate-required")&&("checkbox"!==b.attr("type")||b.is(":checked")?""===b.val()&&(c.removeClass("woocommerce-validated").addClass("woocommerce-invalid woocommerce-invalid-required-field"),d=!1):(c.removeClass("woocommerce-validated").addClass("woocommerce-invalid woocommerce-invalid-required-field"),d=!1)),c.is(".validate-email")&&b.val()){var e=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);e.test(b.val())||(c.removeClass("woocommerce-validated").addClass("woocommerce-invalid woocommerce-invalid-email"),d=!1)}d&&c.removeClass("woocommerce-invalid woocommerce-invalid-required-field").addClass("woocommerce-validated")},
  update_checkout:function(a,c){
    b.reset_update_checkout_timer(),
    b.updateTimer=setTimeout(b.update_checkout_action,"5",c)
  },
  update_checkout_action:function(c){
    if(b.xhr&&b.xhr.abort(),0!==a("form.checkout").length){
      c="undefined"!=typeof c?c:{update_shipping_method:!0
    };
    var d=a("#billing_country").val(),
    e=a("#billing_state").val(),
    f=a("input#billing_postcode").val(),
    g=a("#billing_city").val(),
    h=a("input#billing_address_1").val(),
    i=a("input#billing_address_2").val(),
    j=d,k=e,l=f,m=g,n=h,o=i;
    a("#ship-to-different-address").find("input").is(":checked")&&(j=a("#shipping_country").val(),k=a("#shipping_state").val(),l=a("input#shipping_postcode").val(),m=a("#shipping_city").val(),n=a("input#shipping_address_1").val(),o=a("input#shipping_address_2").val());
    var p={
      security:wc_checkout_params.update_order_review_nonce,payment_method:b.get_payment_method(),country:d,state:e,postcode:f,city:g,address:h,address_2:i,s_country:j,s_state:k,s_postcode:l,s_city:m,s_address:n,s_address_2:o,post_data:a("form.checkout").serialize()};if(!1!==c.update_shipping_method){var q={};a('select.shipping_method, input[name^="shipping_method"][type="radio"]:checked, input[name^="shipping_method"][type="hidden"]').each(function(){q[a(this).data("index")]=a(this).val()}),p.shipping_method=q}a(".woocommerce-checkout-payment, .woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),
      b.xhr=a.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","update_order_review"),data:p,
        success:function(c){
          var d=a('.woocommerce-checkout input[name="payment_method"]:checked').attr("id");
          if("true"===c.reload)return void window.location.reload();
          a(".woocommerce-NoticeGroup-updateOrderReview").remove();
          var e=a("#terms").prop("checked");
          if(c&&c.fragments&&a.each(c.fragments,function(b,c){a(b).replaceWith(c),a(b).unblock()}),
            e&&a("#terms").prop("checked",!0),
            "failure"===c.result){
            var f=a("form.checkout");
          a(".woocommerce-error, .woocommerce-message").remove(),c.messages?f.prepend('<div class="woocommerce-NoticeGroup-updateOrderReview">'+c.messages+"</div>"):f.prepend(c),f.find(".input-text, select, input:checkbox").blur(),a("html, body").animate({scrollTop:a("form.checkout").offset().top-100},1e3)}b.init_payment_methods(d),
          a(document.body).trigger("updated_checkout",[c]);


    jQuery("#shipping_method_0_mis_ddelivery_method").change(
      function(){

        var data = {
            action: 'mis_map_edit',
            city: jQuery('#billing_one').val(),
          }

    jQuery.post(
      "\/wp-admin\/admin-ajax.php",
      data,
      function(res){
        res = JSON.parse( res.slice(0,-1) );
      console.log(res);

          var x = 0;
          var y = 0;
          var count = 0
          for (var i = 0, len = res.length; i < len; i++) {
              x += res[i]['latitude'];
              console.log(res[i]['latitude']);
              y += res[i]['longitude'];
              count++;
          }

          var srx = x/count;
          var sry = y/count;
          jQuery('#map').html('');
          jQuery('.map').css('display', 'block');
          ymaps.ready(function () {
          var myMap = new ymaps.Map('map', {
                  center: [srx, sry],
                  zoom: 12
              }, {
                  searchControlProvider: 'yandex#search'
              }),
              clusterer = new ymaps.Clusterer({
                  iconLayout:"default#imageWithContent",
                  clusterIcons:[
                    {
                          href: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEcAAABHCAYAAABVsFofAAAGO0lEQVR4nO1czUsbTRzO3buB19n3rGDu3kLv+l7aS3qWXgU99Q9oL+2hvRptTSHpQS0xyUJWPCQmLUgLSxAKobH1YGkspgtpWjCRPO/B3bKZnY07s58pDjyXhiYzj7/n9zUfsViAQ4ljqiRhXpaQKhKslCQ8Kkl4JEso0DA+KxKsyBJSJQnzShxTQc7X95EnSBQJlmWCZywSuEHwrEiwnCdIhL02oaHEMS1LSMkEaU8IsScqLUtIKXFMh73mG4cSx7QuA/8IsUGRYCWSJPGQ8vYuXp2+xPpFBZu/v2H79zdsA/hAw/jsooLN05dYf3sXryaOJF0+ObvJKvPY+fQE670TZIcDHLKIcIrhAIe9E2Q/PcH6DXLLyRJSoZGixDE9zslWkshpKjJuCRlHlKYiU0na/2FkgmeBW1FhBgt21vL+AV70TpD1gxA79E6Qff8AL+ysqDCDhUCIKRIs28lHU5EJkhQaFxVsKvPYsbEkf2Vm53SPH2LDL/mIyO34ITbsnHWgxFxUsBk2IXZWFAhBLGKUeexcatgLm4RxuNSwx5KZZwTJDB9TSSIXdWLMBNlENHc+qDCDBRYxUfEvTjEc4JBFkHAU0/OY3KRJaZwFWSRGkBPKg1gJ3qQSYyaIlSjyESMhRX/J9wpeeDXJfgfq2Ru0Gmto15fQLc/hSv4XMFCew1V9Cd3GGtpnb9Dqd6B69dvfK9ZksfQP/hOW0/FDbHgxsfMDNI/uQzMT4RRH96GdH6DpxTwseZBTeclU2FbmsePWAZ8foFlfQleEFBr1JXTdkjQc4JDhf8aHd71JNWJybkqCfgdqYw1tL0ih0VhD243cWPIaaz201bx/IO5nei0cV+/glx/EGKjewS83BFmKVTvrYVnNzxPkRH70xwd8pJ2sXyjP4erHB3wUmaemIuPIeuhMuJIUI6bXwnFQxJgJErUgRnJozZzpZriIr+l3oPotJa8lZrEegvQIMXmChBcRqrHqj/N1isYq2rxzHg5wSEtrZNuHllTzKdK8P3J+gGaYxBgQCfPNp9QWEsGymZyRUkHEEXuVx7hFfQld3rn/PKH8jlFSKHFM0WbFK6moWI2o9bCkpcQxZfE3b+/iFS/zRymxksAvHKWg8a6B3hfLEyQsRebpFp+/6Xeghk0GC7yR63TLsnWdsmTFvNX32S5aYRPBwtkuWjzr+LpnKUZXYkUJj83/aLc9a4eww7cdeMP672/YNvNQlPDYNTn1xWhEKRr1Rb6oxSSH9tK8jizoUsEpynO44l0LzYVrcsImYRxuybklZ0LJKc9G1OfMeuBzbqPVNXwJ5X91nnObIV+DkSEv39ZWOpi1FV2Vv7vH3x79G6ryd/dG26V5goRdP6fG88V/QT+nxuznxGKxWJHguetOYESiFm+UAqydwCLB89seso6xPWTa7+wnsM0rLSD8sC64+2CRlOXSSYmMhjLRfatKMpx9q0rSm32rEsHGjTue1aTYQet+B2rQJUV5VnzHs5pE1hLCfd8rD4ig8mwAe+W69Xh2yiIIiYlKyYDjUxZ21uPmuFu/A9UvJ91YDfh8Dst6RCOXGecHaHqVB9UXPTnZVdtPjBaaN57sMqynNIPX5v/o6ZlAwVLjKOXfmcDSDF47PnJLF6Nu5cWS29kuWo1VtOuL6NLOuzyLq/oiuo1VtM92I3Sa1Bh0SSFLKFxq/J3CKOFSG12PpVRwOljy2k9ge1IJutSu5y8sJ3qw7j5Uk8i6ddBBYzhAjZHsid99MAbr1kw1ieykWNCldj1feg3MTFiQIMt9q0mQGEtKjsO2W4JkCYWLakRv6lXZN/U8J+YmgvQ7npHwQ8MBanZ3PH0jxkQQ83bwfgLbYVvRRRWbTBl56WNuGoUZLNBh3lys9r4Ee69cU5GhG+TmcB3YvXJj6O9XWBJFc0TTXyTwRW7DAWqaioxNJPqT4IX6roUsIWVnRQaaT5HufXGfHw0HqPW+IGvp+TKshbsk8GvoF9gcvYLy7h4yn7eQ/rqHDSevoHzdw8bnLaTtZMNyupF5BcU8eEjyHFElhR7Gy0t0095r6N8/GS8vsUaeICETLI9z3jwoEjyXJ/nNLruhxDGl75GlZIKVooTH9BGYPyQYn+mvveUJEkG/9vY/eqdv6ITJk3QAAAAASUVORK5CYII=',
                          size: [40, 40],
                          offset: [0, 0]
                      }],
              }),
              geoObjects = [];

          HintLayout = ymaps.templateLayoutFactory.createClass( "<div class='my-hint'>" +
            "<div>{{ properties.date }} {{ properties.day }} </div>" +
            "<div class='my-hint2'>{{ properties.price }}руб.</div>" +
            "</div>", {
                // Определяем метод getShape, который
                // будет возвращать размеры макета хинта.
                // Это необходимо для того, чтобы хинт автоматически
                // сдвигал позицию при выходе за пределы карты.
                getShape: function () {
                    var el = this.getElement(),
                        result = null;
                    if (el) {
                        var firstChild = el.firstChild;
                        result = new ymaps.shape.Rectangle(
                            new ymaps.geometry.pixel.Rectangle([
                                [0, 0],
                                [firstChild.offsetWidth, firstChild.offsetHeight]
                            ])
                        );
                    }
                    return result;
                }
            }
          );

            for (var i = 0, len = res.length; i < len; i++) {
              var dayw = ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"][new Date(res[i]['pickup_date'].replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1')).getDay()];
                geoObjects[i] = new ymaps.Placemark([ res[i]['latitude'], res[i]['longitude'] ],
                {
                  date: res[i]['pickup_date'].replace(/(\d+)\.(\d+)\.(\d+)/, '$1.$2'),
                  day: dayw,
                  price: res[i]['price']
                }, {
                  iconLayout: 'default#image',
                  iconImageHref: 'https://sdk.ddelivery.ru/assets/module/img/map-icon1.png',
                  iconImageSize: [28, 30],
                  hintLayout: HintLayout
                });
            }

            clusterer.add(geoObjects);
            myMap.geoObjects.add(clusterer);

            myMap.setBounds(clusterer.getBounds(), {
                checkZoomRange: true
            });
        });
      }
    );
      })


  }})}},
  submit:function(){b.reset_update_checkout_timer();var c=a(this);if(c.is(".processing"))return!1;if(c.triggerHandler("checkout_place_order")!==!1&&c.triggerHandler("checkout_place_order_"+b.get_payment_method())!==!1){c.addClass("processing");var d=c.data();1!==d["blockUI.isBlocked"]&&c.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.ajaxSetup({dataFilter:function(b,c){if("json"!==c)return b;try{var d=a.parseJSON(b);if(d&&"object"==typeof d)return b}catch(a){var e=b.match(/{"result.*"}/);null===e?console.log("Unable to fix malformed JSON"):(console.log("Fixed malformed JSON. Original:"),console.log(b),b=e[0])}return b}}),a.ajax({type:"POST",url:wc_checkout_params.checkout_url,data:c.serialize(),dataType:"json",success:function(c){try{if("success"!==c.result)throw"failure"===c.result?"Result failure":"Invalid response";-1===c.redirect.indexOf("https://")||-1===c.redirect.indexOf("http://")?window.location=c.redirect:window.location=decodeURI(c.redirect)}catch(d){if("true"===c.reload)return void window.location.reload();"true"===c.refresh&&a(document.body).trigger("update_checkout"),c.messages?b.submit_error(c.messages):b.submit_error('<div class="woocommerce-error">'+wc_checkout_params.i18n_checkout_error+"</div>")}},error:function(a,c,d){b.submit_error('<div class="woocommerce-error">'+d+"</div>")}})}return!1},submit_error:function(c){a(".woocommerce-error, .woocommerce-message").remove(),b.$checkout_form.prepend(c),b.$checkout_form.removeClass("processing").unblock(),b.$checkout_form.find(".input-text, select, input:checkbox").blur(),a("html, body").animate({scrollTop:a("form.checkout").offset().top-100},1e3),a(document.body).trigger("checkout_error")}},c={init:function(){a(document.body).on("click","a.showcoupon",this.show_coupon_form),a(document.body).on("click",".woocommerce-remove-coupon",this.remove_coupon),a("form.checkout_coupon").hide().submit(this.submit)},show_coupon_form:function(){return a(".checkout_coupon").slideToggle(400,function(){a(".checkout_coupon").find(":input:eq(0)").focus()}),!1},submit:function(){var b=a(this);if(b.is(".processing"))return!1;b.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});
  var c={security:wc_checkout_params.apply_coupon_nonce,coupon_code:b.find('input[name="coupon_code"]').val()};return a.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","apply_coupon"),data:c,success:function(c){a(".woocommerce-error, .woocommerce-message").remove(),b.removeClass("processing").unblock(),c&&(b.before(c),b.slideUp(),a(document.body).trigger("update_checkout",{update_shipping_method:!1}))},dataType:"html"}),!1},remove_coupon:function(b){b.preventDefault();var c=a(this).parents(".woocommerce-checkout-review-order"),d=a(this).data("coupon");c.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var e={security:wc_checkout_params.remove_coupon_nonce,coupon:d};a.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","remove_coupon"),data:e,success:function(b){a(".woocommerce-error, .woocommerce-message").remove(),c.removeClass("processing").unblock(),b&&(a("form.woocommerce-checkout").before(b),a(document.body).trigger("update_checkout",{update_shipping_method:!1}),a("form.checkout_coupon").find('input[name="coupon_code"]').val(""))},error:function(a){wc_checkout_params.debug_mode&&console.log(a.responseText)},dataType:"html"})}},d={init:function(){a(document.body).on("click","a.showlogin",this.show_login_form)},show_login_form:function(){return a("form.login").slideToggle(),!1}
};
b.init(),
c.init(),
d.init()}
);